<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿßŸÑÿ•ÿµÿßÿ®ÿßÿ™ - Injury Report Form</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 300;
            opacity: 0.95;
        }

        .firebase-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-size: 14px;
        }

        .firebase-status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .firebase-status.error {
            background: rgba(244, 67, 54, 0.3);
        }

        .language-toggle {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .form-content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .label-en {
            font-weight: 400;
            color: #7f8c8d;
            font-size: 14px;
            margin-right: 8px;
        }

        input[type="text"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* PDF Preview Styles */
        #pdfPreview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
            padding: 20px;
        }

        .pdf-container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 20mm;
            position: relative;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2a5298;
        }

        .pdf-header-right {
            text-align: right;
            line-height: 1.8;
        }

        .pdf-header-right h3 {
            color: #2a5298;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .pdf-header-right p {
            color: #555;
            font-size: 16px;
        }

        .pdf-logo {
            max-width: 120px;
            height: auto;
        }

        .pdf-info-box {
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .pdf-field {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .pdf-field-label {
            font-weight: 600;
            color: #2a5298;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .pdf-field-value {
            color: #333;
            font-size: 16px;
        }

        .pdf-description {
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .pdf-description-title {
            font-weight: 600;
            color: #2a5298;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .pdf-description-content {
            color: #333;
            font-size: 15px;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .pdf-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }

        .close-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            background: white;
            color: #333;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
        }

        .success-message, .error-message, .info-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .reference-number {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container, .form-content, .submit-btn, .language-toggle {
                display: none;
            }
            #pdfPreview {
                display: block !important;
                position: static;
                background: white;
                padding: 0;
            }
            .close-btn {
                display: none;
            }
        }

        [dir="ltr"] {
            direction: ltr;
            text-align: left;
        }

        [dir="ltr"] .pdf-header {
            flex-direction: row-reverse;
        }

        [dir="ltr"] .pdf-header-right {
            text-align: left;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿπŸÜ ÿßŸÑÿ•ÿµÿßÿ®ÿßÿ™</h1>
            <h2>Injury Report Form</h2>
            <div class="firebase-status" id="firebaseStatus">
                üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ... / Connecting...
            </div>
            <div class="language-toggle" onclick="toggleLanguage()">
                <span id="langText">Switch to English</span>
            </div>
        </div>

        <div class="form-content">
            <form id="injuryForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label>
                        <span class="label-ar">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂</span>
                        <span class="label-en">(Patient Name)</span>
                    </label>
                    <input type="text" id="patientName" name="patientName" required>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ</span>
                        <span class="label-en">(Mobile Number)</span>
                    </label>
                    <input type="tel" id="mobileNumber" name="mobileNumber" required pattern="[0-9+\-\s()]+">
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ´ÿ®ÿßÿ™</span>
                        <span class="label-en">(ID Number)</span>
                    </label>
                    <input type="text" id="idNumber" name="idNumber" required>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿµÿßÿ®ÿ©</span>
                        <span class="label-en">(Injury Date)</span>
                    </label>
                    <input type="date" id="injuryDate" name="injuryDate" required>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ŸàŸÇÿ™ ÿßŸÑÿ•ÿµÿßÿ®ÿ©</span>
                        <span class="label-en">(Injury Time)</span>
                    </label>
                    <input type="time" id="injuryTime" name="injuryTime" required>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ŸàÿµŸÅ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿµÿßÿ®ÿ© ÿ®ÿ¥ŸÉŸÑ ÿØŸÇŸäŸÇ</span>
                        <span class="label-en">(Detailed Description of Injury)</span>
                    </label>
                    <textarea id="injuryDescription" name="injuryDescription" required placeholder="Ÿäÿ±ÿ¨Ÿâ ŸàÿµŸÅ ÿßŸÑÿ•ÿµÿßÿ®ÿ© ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ..."></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ŸáŸÑ ÿ™ŸÖ ÿ±ŸÅÿπ ÿ®ŸÑÿßÿ∫ÿü</span>
                        <span class="label-en">(Was a report filed?)</span>
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="reportYes" name="reportFiled" value="yes" required>
                            <label for="reportYes">ŸÜÿπŸÖ / Yes</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="reportNo" name="reportFiled" value="no" required>
                            <label for="reportNo">ŸÑÿß / No</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <span class="label-ar">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</span>
                        <span class="label-en">(Email - Optional)</span>
                    </label>
                    <input type="email" id="email" name="email" placeholder="example@email.com">
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="label-ar">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿ±ÿ©</span>
                    <span class="label-en">Submit Form</span>
                </button>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                <div class="info-message" id="infoMessage"></div>
                <div class="reference-number" id="referenceNumber" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- PDF Preview -->
    <div id="pdfPreview">
        <button class="close-btn" onclick="closePDF()">ÿ•ÿ∫ŸÑÿßŸÇ / Close</button>
        <div class="pdf-container" id="pdfContent">
            <div class="pdf-header">
                <div class="pdf-header-right">
                    <h3>ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ ŸäŸÜÿ®ÿπ ÿßŸÑÿπÿßŸÖ</h3>
                    <p>ŸÇÿ≥ŸÖ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ ŸàÿßŸÑÿ™ÿ≠ÿµŸäŸÑ</p>
                    <p style="margin-top: 10px;">Yanbu General Hospital</p>
                    <p>Revenue & Collection Department</p>
                </div>
                <div>
                    <svg class="pdf-logo" viewBox="0 0 200 80" xmlns="http://www.w3.org/2000/svg">
                        <rect x="10" y="10" width="180" height="60" fill="#2a5298" rx="5"/>
                        <text x="100" y="35" font-family="Arial" font-size="16" fill="white" text-anchor="middle" font-weight="bold">ÿ™ÿ¨ŸÖÿπ ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖŸÜŸàÿ±ÿ© ÿßŸÑÿµÿ≠Ÿä</text>
                        <text x="100" y="55" font-family="Arial" font-size="12" fill="white" text-anchor="middle">Madinah Health Cluster</text>
                    </svg>
                </div>
            </div>

            <div class="pdf-info-box">
                <div class="pdf-field">
                    <div class="pdf-field-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂ / Patient Name</div>
                    <div class="pdf-field-value" id="pdf-name"></div>
                </div>
                <div class="pdf-field">
                    <div class="pdf-field-label">ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ / Mobile Number</div>
                    <div class="pdf-field-value" id="pdf-mobile"></div>
                </div>
                <div class="pdf-field">
                    <div class="pdf-field-label">ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ´ÿ®ÿßÿ™ / ID Number</div>
                    <div class="pdf-field-value" id="pdf-id"></div>
                </div>
                <div class="pdf-field">
                    <div class="pdf-field-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿµÿßÿ®ÿ© / Injury Date</div>
                    <div class="pdf-field-value" id="pdf-date"></div>
                </div>
                <div class="pdf-field">
                    <div class="pdf-field-label">ŸàŸÇÿ™ ÿßŸÑÿ•ÿµÿßÿ®ÿ© / Injury Time</div>
                    <div class="pdf-field-value" id="pdf-time"></div>
                </div>
                <div class="pdf-field">
                    <div class="pdf-field-label">ÿ±ŸÅÿπ ÿ®ŸÑÿßÿ∫ / Report Filed</div>
                    <div class="pdf-field-value" id="pdf-report"></div>
                </div>
            </div>

            <div class="pdf-description">
                <div class="pdf-description-title">ŸàÿµŸÅ ÿßŸÑÿ•ÿµÿßÿ®ÿ© / Injury Description</div>
                <div class="pdf-description-content" id="pdf-description"></div>
            </div>

            <div class="pdf-footer">
                <p>ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπ / Reference Number: <strong id="pdf-reference"></strong></p>
                <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ / Submission Date: <strong id="pdf-submission-date"></strong></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        // ‚ö†Ô∏è Ÿäÿ¨ÿ® ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÇŸäŸÖ ÿ®ŸÇŸäŸÖ ŸÖÿ¥ÿ±ŸàÿπŸÉ ÿßŸÑÿÆÿßÿµ ŸÖŸÜ Firebase Console
        const firebaseConfig = {
              apiKey: "AIzaSyAtt0H0mfthkSxeNJjfapl3sz6XTzLTA88",
  authDomain: "yanbu-injury-reports.firebaseapp.com",
  projectId: "yanbu-injury-reports",
  storageBucket: "yanbu-injury-reports.firebasestorage.app",
  messagingSenderId: "542156965891",
  appId: "1:542156965891:web:6e5a2ed242192bdf2c6636",
  measurementId: "G-CM4YNBXPH6"
        };

        let db;
        let firebaseInitialized = false;

        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    updateFirebaseStatus(true);
                    console.log('Firebase initialized successfully');
                } else {
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    updateFirebaseStatus(true);
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateFirebaseStatus(false, error.message);
                // Continue with local storage fallback
            }
        }

        function updateFirebaseStatus(connected, errorMsg = '') {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.textContent = '‚úÖ ŸÖÿ™ÿµŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ / Connected to Database';
                statusElement.className = 'firebase-status connected';
            } else {
                statusElement.textContent = '‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã / Offline - Will save locally';
                statusElement.className = 'firebase-status error';
                if (errorMsg) {
                    console.warn('Firebase error:', errorMsg);
                }
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            // Set max date to today
            document.getElementById('injuryDate').max = new Date().toISOString().split('T')[0];
        });

        let currentLang = 'ar';

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            const body = document.body;
            const langText = document.getElementById('langText');
            
            if (currentLang === 'en') {
                body.setAttribute('dir', 'ltr');
                body.style.direction = 'ltr';
                langText.textContent = 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ŸÑŸÑÿπÿ±ÿ®Ÿäÿ©';
            } else {
                body.setAttribute('dir', 'rtl');
                body.style.direction = 'rtl';
                langText.textContent = 'Switch to English';
            }
        }

        function generateReferenceNumber() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `INJ-${timestamp}-${random}`;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showMessage(type, messageAr, messageEn) {
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            const infoMsg = document.getElementById('infoMessage');
            
            // Hide all messages first
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            infoMsg.style.display = 'none';
            
            const message = `${messageAr} / ${messageEn}`;
            
            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            } else if (type === 'error') {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            } else if (type === 'info') {
                infoMsg.textContent = message;
                infoMsg.style.display = 'block';
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successMsg.style.display = 'none';
                errorMsg.style.display = 'none';
                infoMsg.style.display = 'none';
            }, 5000);
        }

        async function saveToFirebase(formData) {
            if (!firebaseInitialized || !db) {
                throw new Error('Firebase not initialized');
            }

            try {
                const docRef = await db.collection('injuryReports').add(formData);
                console.log('Document written with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding document:', error);
                throw error;
            }
        }

        function saveToLocalStorage(formData) {
            try {
                let reports = JSON.parse(localStorage.getItem('injuryReports') || '[]');
                reports.push(formData);
                localStorage.setItem('injuryReports', JSON.stringify(reports));
                console.log('Saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showLoading(true);

            // Generate reference number
            const referenceNumber = generateReferenceNumber();

            // Get form data
            const formData = {
                referenceNumber: referenceNumber,
                patientName: document.getElementById('patientName').value,
                mobileNumber: document.getElementById('mobileNumber').value,
                idNumber: document.getElementById('idNumber').value,
                injuryDate: document.getElementById('injuryDate').value,
                injuryTime: document.getElementById('injuryTime').value,
                injuryDescription: document.getElementById('injuryDescription').value,
                reportFiled: document.querySelector('input[name="reportFiled"]:checked').value,
                email: document.getElementById('email').value || 'N/A',
                submissionDate: new Date().toISOString(),
                submissionDateFormatted: new Date().toLocaleString('ar-SA'),
                status: 'pending'
            };

            let savedToFirebase = false;
            let firebaseDocId = null;

            // Try to save to Firebase first
            if (firebaseInitialized) {
                try {
                    firebaseDocId = await saveToFirebase(formData);
                    savedToFirebase = true;
                    console.log('Successfully saved to Firebase');
                } catch (error) {
                    console.error('Firebase save failed, falling back to localStorage:', error);
                    saveToLocalStorage(formData);
                }
            } else {
                // Save to localStorage as fallback
                saveToLocalStorage(formData);
            }

            // Update PDF preview
            document.getElementById('pdf-name').textContent = formData.patientName;
            document.getElementById('pdf-mobile').textContent = formData.mobileNumber;
            document.getElementById('pdf-id').textContent = formData.idNumber;
            document.getElementById('pdf-date').textContent = formData.injuryDate;
            document.getElementById('pdf-time').textContent = formData.injuryTime;
            document.getElementById('pdf-report').textContent = formData.reportFiled === 'yes' ? 'ŸÜÿπŸÖ / Yes' : 'ŸÑÿß / No';
            document.getElementById('pdf-description').textContent = formData.injuryDescription;
            document.getElementById('pdf-reference').textContent = referenceNumber;
            document.getElementById('pdf-submission-date').textContent = formData.submissionDateFormatted;

            // Generate and send PDF
            try {
                await generateAndSendPDF(formData);
                
                // Show success message
                showLoading(false);
                
                if (savedToFirebase) {
                    showMessage('success', 
                        'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© Ÿàÿ≠ŸÅÿ∏Ÿáÿß ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!', 
                        'Form submitted and saved to database successfully!');
                } else {
                    showMessage('info', 
                        'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© Ÿàÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ≠ŸÑŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.', 
                        'Form submitted and saved locally. Please check internet connection.');
                }
                
                // Show reference number
                const refElement = document.getElementById('referenceNumber');
                refElement.textContent = `ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπ / Reference Number: ${referenceNumber}`;
                refElement.style.display = 'block';
                
                // Reset form after 5 seconds
                setTimeout(() => {
                    document.getElementById('injuryForm').reset();
                    refElement.style.display = 'none';
                    submitBtn.disabled = false;
                }, 5000);
                
            } catch (error) {
                console.error('Error:', error);
                showLoading(false);
                showMessage('error', 
                    'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 
                    'Error submitting form. Please try again.');
                submitBtn.disabled = false;
            }
        }

        async function generateAndSendPDF(formData) {
            const { jsPDF } = window.jspdf;
            
            // Show PDF preview
            document.getElementById('pdfPreview').style.display = 'block';
            
            // Wait for rendering
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Capture PDF content
            const pdfContent = document.getElementById('pdfContent');
            const canvas = await html2canvas(pdfContent, {
                scale: 2,
                useCORS: true,
                logging: false
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = 0;
            
            pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            
            // Prepare email data
            const emailData = {
                to: 'injury2030@outlook.com',
                subject: `Injury Report - ${formData.referenceNumber} - ${formData.patientName}`,
                body: `
ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿ•ÿµÿßÿ®ÿ© ÿ¨ÿØŸäÿØÿ© / New Injury Report

ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπ / Reference: ${formData.referenceNumber}

ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿäÿ∂ / Patient Information:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÿßŸÑÿßÿ≥ŸÖ / Name: ${formData.patientName}
ÿßŸÑÿ¨ŸàÿßŸÑ / Mobile: ${formData.mobileNumber}
ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ´ÿ®ÿßÿ™ / ID: ${formData.idNumber}
ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä / Email: ${formData.email}

ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ•ÿµÿßÿ®ÿ© / Injury Information:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÿßŸÑÿ™ÿßÿ±ŸäÿÆ / Date: ${formData.injuryDate}
ÿßŸÑŸàŸÇÿ™ / Time: ${formData.injuryTime}
ÿ±ŸÅÿπ ÿ®ŸÑÿßÿ∫ / Report Filed: ${formData.reportFiled === 'yes' ? 'ŸÜÿπŸÖ / Yes' : 'ŸÑÿß / No'}

ÿßŸÑŸàÿµŸÅ / Description:
${formData.injuryDescription}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ / Submission: ${formData.submissionDateFormatted}

Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÜÿ≤ŸäŸÑ ÿßŸÑŸÖÿ±ŸÅŸÇ PDF ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©
Please download the PDF attachment for the complete version
                `.trim()
            };

            // Open email client
            const mailtoLink = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
            window.open(mailtoLink);
            
            // Download PDF
            pdf.save(`Injury_Report_${formData.referenceNumber}.pdf`);
            
            // Close preview after a delay
            setTimeout(() => {
                closePDF();
            }, 2000);
        }

        function closePDF() {
            document.getElementById('pdfPreview').style.display = 'none';
        }

        // Function to view all reports (for testing)
        function viewAllReports() {
            if (firebaseInitialized) {
                db.collection('injuryReports')
                    .orderBy('submissionDate', 'desc')
                    .get()
                    .then(querySnapshot => {
                        console.log('Total reports:', querySnapshot.size);
                        querySnapshot.forEach(doc => {
                            console.log(doc.id, '=>', doc.data());
                        });
                    })
                    .catch(error => {
                        console.error('Error getting documents:', error);
                    });
            } else {
                const reports = JSON.parse(localStorage.getItem('injuryReports') || '[]');
                console.log('Local reports:', reports);
            }
        }

        // Make function available in console for testing
        window.viewAllReports = viewAllReports;
    </script>
</body>
</html>